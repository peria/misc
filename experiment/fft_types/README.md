# FFT 実装系による速度差の測定

一口に FFT と言っても Stockham(Self-sorting) / Cooley-Tukey(in-place)、時間間引き(DIT)/周波数間引き(DIF)、など実装方法にはバリエーションがある。
ひとまずその大まかな時間差を計測するコード類を書いているつもりである。

実験内容としては n 個の複素数に FFT と逆 FFT をかける作業を繰り返す。10^7 回、もしくは 2 秒を超えた時点で止めて FLOPS 計算している。FLOPS 算出が正しいのかは少し疑問だが、とりあえずルーチン同士の比較にはなると思う。

## 比較対象

- `PMP` : 独自多倍長計算の中で使っている FFT から流用したもの。畳み込みへの応用しか想定しないので out-of-order の in-place FFT である。
- `Cooley-Tukey` : in-order の in-place FFT。 PMP から派生させて再配列するようにしている。in-order なので順変換と逆変換でルーチンの共有ができてメンテナンスコストが低い。
- `Stockham-DIX` : self-sorting FFT。DIT (時間間引き) と DIF (周波数間引き) で作ってみた。
- `DPMP` : PMP のうちキャッシュより小さいサイズの計算をするときはそのエリアだけ最後までやるように分割。
- `PMP2` : データ列に padding を入れて cache conflict を避けられるか実験。PMP の派生。
- `PMP5` : out-of-order のまま 6 step FFT の最後の転置以外を実装してみた実験。
- `Stockham6` : StockDIT を　6 step FFT 化してみた。

## 実験

実験内容としては n 個の複素数に FFT と逆 FFT をかける作業を繰り返す。10^7 回、もしくは 2 秒を超えた時点の計算まで行い、MFLOPS を計算している。FLOPS 算出は [fft.h](fft.h) に書いている通り。往復計算なのでこれを 2 倍して時間で割っている。厳密には FLOPS 数が正確というわけではないが、とりあえずルーチン同士の速度比較にはなる。結果は以下の表の通り。

| #    |       PMP |      DPMP |      PMP2 |      PMP5 |    Cooley |  StockDIT |  StockDIF | Stockham6 |
|------|----------:|----------:|----------:|----------:|----------:|----------:|----------:|----------:|
| 2^ 2 |  1691.542 |  1521.253 |  1443.737 |  1611.374 |  1465.517 |  1770.833 |  1730.280 |  1559.633 |
| 2^ 3 |  2679.426 |  2522.523 |  2181.818 |  2564.885 |  2492.582 |  2024.096 |  2222.222 |  2225.166 |
| 2^ 4 |  4839.858 |  4677.558 |  3825.598 |  4681.583 |  4217.054 |  4544.695 |  4763.573 |  4473.684 |
| 2^ 5 |  5119.499 |  5131.174 |  3861.562 |  5140.234 |  4631.616 |  5064.298 |  4926.634 |  4786.181 |
| 2^ 6 |  4967.291 |  6488.060 |  4735.447 |  6488.220 |  5834.242 |  6584.234 |  5701.415 |  6069.253 |
| 2^ 7 |  6166.945 |  6006.623 |  4032.832 |  5935.572 |  5532.201 |  6074.161 |  5619.905 |  5740.522 |
| 2^ 8 |  6988.024 |  6952.868 |  4888.480 |  7109.210 |  6403.019 |  7285.074 |  6915.041 |  6774.967 |
| 2^ 9 |  6423.847 |  6393.969 |  4486.662 |  6339.852 |  5799.739 |  6474.406 |  4527.931 |  6094.596 |
| 2^10 |  6958.587 |  7168.788 |  5000.100 |  7052.198 |  5215.872 |  6800.435 |  6306.701 |  3944.000 |
| 2^11 |  6335.137 |  6254.390 |  4445.523 |  6366.032 |  5829.879 |  5186.914 |  5392.244 |  4109.687 |
| 2^12 |  6817.321 |  6833.406 |  4681.359 |  6717.260 |  4796.670 |  6085.976 |  6044.197 |  5148.033 |
| 2^13 |  6413.648 |  6369.796 |  4511.089 |  6326.378 |  4229.308 |  5582.201 |  5385.519 |  4715.151 |
| 2^14 |  6573.400 |  5973.869 |  3420.742 |  6413.525 |  4476.502 |  5947.548 |  5604.401 |  3707.347 |
| 2^15 |  6152.503 |  6202.884 |  4427.465 |  6166.610 |  4822.450 |  5636.604 |  5699.076 |  4153.393 |
| 2^16 |  6497.501 |  6519.783 |  4659.115 |  4790.682 |  4614.573 |  6417.285 |  5860.229 |  3625.736 |
| 2^17 |  5939.486 |  5893.657 |  3183.739 |  4438.500 |  4190.898 |  5224.548 |  4956.262 |  3504.865 |
| 2^18 |  5148.733 |  6264.378 |  3328.967 |  4278.723 |  3894.953 |  4158.759 |  3996.814 |  3635.290 |
| 2^19 |  4103.351 |  5550.591 |  2907.581 |  4144.384 |  3208.611 |  3641.092 |  3417.850 |  3289.239 |
| 2^20 |  4319.801 |  6183.377 |  3116.397 |  3817.276 |  3409.543 |  3772.190 |  3619.898 |  3206.389 |
| 2^21 |  3745.354 |  5763.545 |  2850.816 |  3632.697 |  2963.868 |  3373.812 |  3264.553 |  3159.346 |
| 2^22 |  4196.344 |  6259.031 |  2958.359 |  2150.827 |  2844.369 |  3413.450 |  3317.206 |  2168.668 |
| 2^23 |  2250.315 |  5560.520 |  2767.226 |  2162.246 |  2541.196 |  3172.721 |  3056.222 |  2501.521 |


## 考察

キャッシュフレンドリーにした PMP (DPMP) が上手く働いたみたいで、2^18 以上でも爆速になった。
